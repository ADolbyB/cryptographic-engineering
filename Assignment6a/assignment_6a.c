/**
 * Joel Brigida
 * CDA-4321: Cryptographic Engineering
 * Assignment 6: Kyber / ML-KEM Post-Quantum Algorithms
 **************************************
 * TO COMPILE USING GCC, use commands:
 * gcc kyber_src/*.c assignment_src/*.c  assignment_6a.c -o assignment_6a.out && ./assignment_6a.out
*/

#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>

#include "assignment_src/kpke.h"
#include "assignment_src/mlkem.h"
#include "assignment_src/print_helpers.h"

#include "kyber_src/params.h"
#include "kyber_src/randombytes.h"

void kyber_pke_test(uint8_t mA[KYBER_INDCPA_MSGBYTES], uint8_t mB[KYBER_INDCPA_MSGBYTES]) 
{
    uint8_t pkA[KYBER_INDCPA_PUBLICKEYBYTES];           // Public Key
    uint8_t skA[KYBER_INDCPA_SECRETKEYBYTES];           // Secret Key
    uint8_t ctB[KYBER_INDCPA_BYTES];                    // Cypher Text
    uint8_t rB[KYBER_SYMBYTES];                         // Random Generated Text
    
    // random bytes length is 32 bytes (256 bits)

    // 1a: Alice's Initialization
    kpke_keygen(pkA, skA);

    // 1b: Bob's Encryption Process
    randombytes(mB, 32);
    randombytes(rB, 32);
    kpke_encrypt(ctB, mB, pkA, rB);

    // 1c: Alice's Decryption Process
    kpke_decrypt(mA, ctB, skA);
}

void kyber_kem_test(uint8_t ssA[KYBER_SSBYTES], uint8_t ssB[KYBER_SSBYTES]) 
{
    uint8_t pkA[KYBER_PUBLICKEYBYTES];
    uint8_t skA[KYBER_SECRETKEYBYTES];
    uint8_t ctB[KYBER_CIPHERTEXTBYTES];

    // 2a: Alice's Initialization
    mlkem_keygen(pkA, skA);


    // 2b: Bob's Encapsulation
    mlkem_encaps(ctB, ssB, pkA);


    // 2c: Alice's Decapsulation
    mlkem_decaps(ssA, ctB, skA);
}

int main(void) {

    uint8_t mA[KYBER_INDCPA_MSGBYTES];
    uint8_t mB[KYBER_INDCPA_MSGBYTES];
    uint8_t ssA[KYBER_SSBYTES];
    uint8_t ssB[KYBER_SSBYTES];

    kyber_pke_test(mA, mB);
    kyber_kem_test(ssA, ssB);

    print("\n################################");
    print("###### K-PKE FINAL RESULT ######");
    print("################################\n");

    print("Alice's message:");
    print_hex_bytes(mA, KYBER_INDCPA_MSGBYTES);
    print("Bob's message:");
    print_hex_bytes(mB, KYBER_INDCPA_MSGBYTES);

    if(memcmp(mA, mB, KYBER_INDCPA_MSGBYTES)) {
        print("!!! ERROR !!!");
        print("Alice's message DOES NOT match Bob's!");
        print("");
        return 1;

    } else {
        print("");
        print("Alice's message matches Bob's!");
        print("");
    }

    print("\n#################################");
    print("###### ML-KEM FINAL RESULT ######");
    print("#################################\n");

    print("Alice's shared secret:");
    print_hex_bytes(ssA, KYBER_SSBYTES);
    print("Bob's shared secret:");
    print_hex_bytes(ssB, KYBER_SSBYTES);

    if(memcmp(ssA, ssB, KYBER_SSBYTES)) {
        print("!!! ERROR !!!");
        print("Alice's shared secret DOES NOT match Bob's!");
        print("");
        return 1;

    } else {
        print("");
        print("Alice's shared secret matches Bob's!");
        print("");
    }

    return 0;
}

/** Code Output: Joel Brigida

---------K-PKE KeyGen---------
Alice's public key:
0x232ABF9EB1A29FDB700243CF960444B4202D4B7425635C635A2929B98AC0EF34119FF7421F9A83F7B98D0C32BB208092A7248E4F36172AD4564F573E44E75491236BEEFC99BF793C31FB1A29452017931CE6A76DF80B16E814A943F37B6B1B412134B9820A3E00D033AF9149D31ACF3D8A597DF3CB4B3AC40295B3E58312E06655E3D91715763800E2735E22232C78282BC7B9486B637D569702F96008552656D89B0E4803681A2DA6017C72EC722CA707D9C62C783B8EB35390CC284DA17827FCD5491DC86027275B66585A93A307D171AFBE8C585E284485AB7CDEFB8D82FC9FCA4B4B99083CCF8957E2091C07D3884F3B7F82690D3308B6D500A05DA330676457E12AB97E568C9416BFBAAAC93007564E22B5653B48548419F2C0BC0A3381883608B13C8410D69932F678E36A46FFDC3E9CC41948F838FF6B8E10F34AAD76ACBD3205863558F7EC8CC35A5248D554F1C82E375C33A019145E95CF83F4AF751A7915C25894F648FB851A5F491D6B180FA67A66995A919BB1851A161526B03456EAC51D910F133441ABA85648F457D73BCA5E1B34832987055C033DE9BDB3B065B33411F59085EB61A10895C5E851A0AE38C7BAC017C77ABE4446375ACBA88605078761265BF343E88A47B0A8945C51B1FA1C6C30BAA502E636C50BC8E6985BF1180DC2F53AC4F47B5B1B24320A031343B7C1F34521C08409A2BC0858CAA8F29F406B1EAEF01A33718AE95C25B076883F57C31505068202C0822A9138F6B45B68CE0F8257C23A2772464AA5894099F562D456AEFA6691BD967488304A9A0328193ACF8ECCB7EBC0645EBAC64EE59BABBC8576C7BB9D610F5B16CDB698562630A09D8B85FBE7C9EA339AB88A7E13CC346D9113A9E53A271891ED3B9349C63C6360C9B65C12616CB78C319D722831CFF2B171333618E3BE6B64AA29B987271161EF504EAA288BBB2810E9984A7B790FC4546D6B191834DA4D4BB2730E4B7A75B7121D194320E63D5735C9FDC134452139125767ABF47CE88B476E0B0909010AC8B9392795C32027738A654D6B3B7BE67286D3E2966F29C3AA283B258C973CC758887073E66625CD14968CD9CDC85F14883D98A613D0A2BFF92814A0AE726C94AA
Alice's secret key:
0x8EFC83E24B26AFA5186C73B0F021A08665BEFBEC97DD5ABE28DBB5C6B7849B24254A200613B1007665C77005522A822DE1C614405B20841A732C5293C1F1C5F38BAC83D183AA696CAFD2C2345620A3B2548E955D83F1C7D2290A216B65BC4514452C96D343A380BC1A8B4C7993787BD562C4F2503A33379A3731419EBAAF5D0561DF2ACBC5295296DC2E249625727523985941DDF8C633560FB5DA8CB2A90CD165657821BEF9BA849D950AB8D40FD7C30DEE1C0C96900856BB9E7158C980181725E1465800824AEA6F9FC6A23CF1A552AB5DADE6507C7028BAC966636071BB1523765603612A1A6EDC195CB0AA9051908318489E974A5FA683203B177CC86D528C6590CB3D0B519A5F22303BB86F21796E32F78BCB944A84E1B35E02BB45D21E859271C3B157FD1921E97A1807E508A9F37B962832C6E2B2271571C36945E25A3C776165C4F210C2370BD597BBE835AFE3D61B9F5C108EC0B12AEBB23FC22B18B7A688D3687C151CFEFBCDEA0542B1AB29DB448048C03D5F56B99954BE6815AEA51338EAC22ABF02BE640C305D3A23A9DC9D603850F7E49101F11DE9FA50844468417BCC5B657870516CD7F9B1DCC97E137132DC74492FC2C9AB99C9DE299057512785D4A5F61115D7E9A3F3E3BC52665CFBDA144BAA6A4BF1C7F9AA80C6214315C4A46DE8C3106316BD6CCEBEB64251B0B289197781E59E90CAA9B6231CB1155A15DBAFAD1CB9B51AA700BBB36E01B841734146521FD6D46271FBC2C2E437A726CAB2B89F7D3CA94AFB1E5193423C527EBA790639272F1B09C8C2AA39D12A3D83FA500A324BDA83BF574882DDFA11A11B7D7BC233101A66F45BBE3A59029E416D38710CED7682C90259395C5D7EB269BE69B354C51E5BCC4A73B15319EA3F4222723239134E1C986DB97FF69B84587980CB21767B8461B2AABE543B0B16978A18B28D3B608E041156CBE58FCEF27834458F59B783A0B38071F3418F7545A535809BC077FAC40106095CFC579D429C75E0DACD98B8BA14915D7D0214D0BA781786BA13AC9D7B74666987C41A7B025C6BAFF973B2E2B948155871753B3A145B55

---------K-PKE Encrypt---------
Bob's random:
0xB3E3D8645F17A738B7239F68231229BDE604AB6C349EB4EB80F193232EE8B92E
Bob's message:
0x33D4E25EB29927B29B6D197BB8FDA675DA6AF6ADA65E330C74C54257C4066CFA
Bob's ciphertext:
0x08E5971B1646A53AEB0F2AA7C30CD6BBE25D579739774CFFD1BD05161E179AD608A6D147A0E27939776B544DF42E8D2334FD470DE701ACF1D39DAFC67F534C5E84D27DAF4CB4E2DBA97B330471A069588FF0043B0E47C756A9EEF2DD9700C64BA23A89A2271E0085413C9DDD7053DA5BF10EB70084FE2F0F764E71877481CE8A1A1B8BB448A693929DB5DD57767060CD9A721FDC9444F0FBC593FA490B40238AA082CCAB00757BAA6896E2741D1311784088A09295257900C9399BE8BBE4FBE90E82128312D903B6EF6D7ADC6D8EB5C509EA802EB1B02DC99A99397016E98DF5F19454227D0359D52C5D44F4FE9312B34D72ACAB98D9D2D9F48A763D9B04A8EB79923E9240C99F9CC6286307D3583A55CBAD1C371C8102342F51A7A802547DC69E384DD426447476CDECBEEFE49DA4A3BA93FAE62798050E17F69436908DACDDEC0D27247EA914E8537D6A20774A9CA68AC828B307D5F241FAD9E9FD13C3A010E9EF72D469180B539D279B19418E907C06F151A824008575745E1129275BCCABDC35F6701443E805A91410B779BD7802FD51F8C7B6442D0DDA43FBBF5E6D131F67E6A6D87D1B8030B5D51C7F01C2E88D3936F30E4CB3BC038D0D751B1A0BBE28476173CF083D8BCA1647CB950D135BDD7DF698F6DD0B2F16D360F29940AA63CEA4C2E74D40FAD31EA5AA4CFEA8FD1E0666F3194AF8E85D00A3F16F221E0F5A45D4D1DC17F2E3C71C90AE44D3C43227F95345F23444D3BB163754AC9048C027DF26744A29D4BFCEF33893AF8C4962ECE5F8E607DEB25F7D41A6B9A6126CCCE73FB6FC30AAD1054288776AC4F713C85C3A4F430386DEF18DFA8AD35BDB5873038361D5398F8881EA23F3671838BFC675ED65D826291FFEA0604076BB9BC8922AFBBF55CB34DE4B8668782109AA2A8768E03C8D39547D490D56A1B89CBBB9D1559967E4BAC52B4FD0D6C0BB45F89E43BB3546B4758217C745AF92C11AF5077D0B3F789789DD8F1DD88E912BF27B276C307C1CAB0EAA306E5FD4A36CADA3510C21DD4CAE16B93E9C43E1C357124246AFA25FA15FECCE6715F9CF2683B5648D033D33

---------K-PKE Decrypt---------
Alice's decrypted message:
0x33D4E25EB29927B29B6D197BB8FDA675DA6AF6ADA65E330C74C54257C4066CFA

---------ML-KEM KeyGen---------
Alice's public key:
0xF3DA2C3437B594F12E421B3E45F1ACFB8959DFE745A88261197A9FB7755FF60C5B1DB1449A3C30B762C488F5BD76E584AA8041647345CF62BA0CAC25025778C3382067B07851B9608034455348588E31BEB3E4A4C923BB12BC6D19E08C55940A15D62A50584425582CA2903AA5A0BD1D347FB7A5CE216C155AB182CB6B3F6BB8AE93D79B30AA74B0B8A61BB5BA5D133407488DD8278AC0459CE1B6BF4EAC36F9A5900F4948B6D04EDBC00226B835C8303CBA6B6B6347265ED055FBE48E2CE3152D189EBCF40E37627EA9E00F6CE24C0B6C9448602852F07975982A22DA48DAD54629F3B32ED0759167B827433E7B2B647FA543FC18854BD78F741AB738405620FC14844C346876CB38810B4F420B7744188A91A82B8C2E5FB12C0CB07D1594C40E428440C2A19A22834A3C8FAAA4201A0B926CC52392C09CB3FB290BE67F7758CA0EC850E969658D0967333539C9EC8FE2192BDDF89973E807E4F9AD4B502A0DE94DF286A201AAC56668862634C187889A0356C97C94823D3601EC4B0F6D2C50350479E39199A2D8277199134B726F3FA74DE4BBA699435CE9A085BD716065110AA973900AD359A118A1CB902C05AC65D91C421B2046262B75A7F9C1715797CCFA93008459D8B1A84014A02C96B5ED4C636EB79AFB920E7A7C24A991CF7F58C392F16A57CB5BD7285D42B95A0B14AA7CF490633754CD11C373011CE9285795B568CA24B371B69310F40C74BB3A7C32999DAC3A72069B479388BCDA737DB1291CEA32EB2BA20D62AFEBEA241CC27DF848BC5A48971ECA6F3F322866A6CCEEA53A953402C2B28161D466749155BB05C18F49A1EBB60F941C577F65708115205E64C3DF70C0C054C0925417DE0321605104DF13278C1B452B4BB35EF1CD0D0C3FD615C8845354D37617E7434819E9373A2A0E8DD39124F218A7D579A4575A90C0791D377E7E365419477DBF33B00B775231028ED5CB69E76A4D3118A6C1A57DEEAACD3977A423663D53D789CAA229C1A27170662F849CA97344B0FE6B599390BB48EC15D28417A4EB3EF51591F8B6A18A69A2B5D970CF1ABB8AE09789DA90BA1262B1107525852636BFD7ECC77411C0FD815A41E3947BF93054D349E1A28A9A4F95
Alice's secret key:
0x08D252685A8809E13F90A090ABA89A6216C012991763D2A08EA69C8F569BD2A1419877CB85F5161A92086A3C4223772F86887853C9823BFA357676910853B5044014A2831D21502701DC0D98A06D3567BFC7E9AD31D2B4F6A10EE4D4545F4C4DE96649BB2C751555B606104D2B2510B0D982DBF3244CD9AE8E008E2D3B633CAC61929B2EA5F030223A54E23341C6C5500989456488AE57F23018C9005A06232F2C0C9BB6AB08468341D6C07BC360DD75CDBE6989479C0CC128014396AA676C9887166023886725568AB11169BE86A4CCE91541FC379D01B8B3014FC8386977C5A8C4C95A67A6B16F37CE505C0E11AC3275E87073D5AF772658BCDA406BC46FCF42B6E74B3C1EE6A3D4B5019F37B870399B285801CBE83A3A2A4EE5F665DD5686B134147FE6AA773574BD5C5F2A3A1731B10D5DE1C06F25A3160AAEEA9BC29B63C93A43579E1303BAC8C09E64BACD41A8791CA7F197B53BAC7BB9C0CA6F42636F64AA119628D6312FAC6C1D7B694ABEB1A61B3305FD86025A0AC104F621C0CBC8CEBC38ABD0C427C636A68B2FBF970747DA81891943BD516169B72A4956B178D129B24207512367410605C4F2028E5C7F55072008404144AAAD7FD680EE0532BDDBA4356147FB5127447691C42355B70B7590381F2F06C87B55AE79A815B0AC4CEB3CBE5D39A4509BC72723A9393844F65B41B90A7468A94B7F793A276A7B4A65975AAB615DCC3CC189C5E117BA16F10443B66E16979FF8544A2D51CA720BBEAD4B68E98C52A97593D0448FB58022B655406AFA7BBA9A9FFC6B9584B561F7B756E5EB79303C90533C846607338EBA70EB4A012D0C3656189590669D38567DF30615B5F0B4DF9B9D91D6BA52B6AB24B7036820917A1822326BAB5D6259E4327A4EC6641C2972ECCC3065DA375820BAA098BA5F69AD78DBB9D093BC97C088CE37C7586CB9F9B266F68884D85A5F688A440F970610159469270E516432C6FCA0A46932C686B23E2B1F94555989B0CDF63701E7E81F981A2C66D27EEE08438718B73AB31A81BC268F681A36A1CF00A87DCD42417975CE75440F5C19092B0C873600AAF3DA2C3437B594F12E421B3E45F1ACFB8959DFE745A88261197A9FB7755FF60C5B1DB1449A3C30B762C488F5BD76E584AA8041647345CF62BA0CAC25025778C3382067B07851B9608034455348588E31BEB3E4A4C923BB12BC6D19E08C55940A15D62A50584425582CA2903AA5A0BD1D347FB7A5CE216C155AB182CB6B3F6BB8AE93D79B30AA74B0B8A61BB5BA5D133407488DD8278AC0459CE1B6BF4EAC36F9A5900F4948B6D04EDBC00226B835C8303CBA6B6B6347265ED055FBE48E2CE3152D189EBCF40E37627EA9E00F6CE24C0B6C9448602852F07975982A22DA48DAD54629F3B32ED0759167B827433E7B2B647FA543FC18854BD78F741AB738405620FC14844C346876CB38810B4F420B7744188A91A82B8C2E5FB12C0CB07D1594C40E428440C2A19A22834A3C8FAAA4201A0B926CC52392C09CB3FB290BE67F7758CA0EC850E969658D0967333539C9EC8FE2192BDDF89973E807E4F9AD4B502A0DE94DF286A201AAC56668862634C187889A0356C97C94823D3601EC4B0F6D2C50350479E39199A2D8277199134B726F3FA74DE4BBA699435CE9A085BD716065110AA973900AD359A118A1CB902C05AC65D91C421B2046262B75A7F9C1715797CCFA93008459D8B1A84014A02C96B5ED4C636EB79AFB920E7A7C24A991CF7F58C392F16A57CB5BD7285D42B95A0B14AA7CF490633754CD11C373011CE9285795B568CA24B371B69310F40C74BB3A7C32999DAC3A72069B479388BCDA737DB1291CEA32EB2BA20D62AFEBEA241CC27DF848BC5A48971ECA6F3F322866A6CCEEA53A953402C2B28161D466749155BB05C18F49A1EBB60F941C577F65708115205E64C3DF70C0C054C0925417DE0321605104DF13278C1B452B4BB35EF1CD0D0C3FD615C8845354D37617E7434819E9373A2A0E8DD39124F218A7D579A4575A90C0791D377E7E365419477DBF33B00B775231028ED5CB69E76A4D3118A6C1A57DEEAACD3977A423663D53D789CAA229C1A27170662F849CA97344B0FE6B599390BB48EC15D28417A4EB3EF51591F8B6A18A69A2B5D970CF1ABB8AE09789DA90BA1262B1107525852636BFD7ECC77411C0FD815A41E3947BF93054D349E1A28A9A4F951432E60DCF56F2AFDFF533A9DEEF072900A1C1BE4BE2659B9E6FD8358A1E238697876F856EA042D7FACB6BD925003898AD3B2F7BBAAC6159AB47EC9F75643BBE

---------ML-KEM Encaps---------
Bob's shared secret:
0x4A7EE1F982644EEDE653964D0752B5C518D9AFD4A2300827E35D67D26E8490C0

Bob's ciphertext:
0xBE81EF1E5A710A98FE21D7DC650CF6B9C934E6A849F6B99ADCF8BE4ABAFA0C556238E8F45E8EAA2B08F2FC3B84AA1E26254ABEA9D1E98A99A069BBF17ECF65CDDA13090AF4505F9E4476FDAE5579C00A5A221C3B89F648D98BDD06C058292F3C0E1CAE065B2F78F03FD9B0A5C2972FDD020552FEBAA5DFDD35D73116F2123B1092587C276380D4EEC17BB01E243A1F597E9A06E2EF0315FBD70BD5A9404330037582DC3ABF01E2ADADCF0295C361B9471B6B05730D530E6268039272C82A4DD9FF1DC67C58A480120D87BE1E72664F69EF2C423135D39B8625870BB3D6D1C92D581B14A80F02A36011F7E7CB19533A6CB01BC54CC58A04D236939F61EF02C7AD03B72CC829739ACF709471AAA8B32546DCD00DBD0F0CE0BDD37484DBDD5A7812D5AAD134E58F1061CC382A18B90A7BB62E51C5FC519DC52772C4D4825845AC90706DE944B62965F3E0E2FFD0AF5D56F22C4ED0AC079307B0E7D7F348D2801B59247E98AED337C2CCDF8A99F5E22D2661FDACE31A2457F52B0D9D63755B5F623A713F9E4B9FFC1986C8869C08FB3050C31884B942CF1F683F3748B8E9FA3E1AD7F1DAB80B7B27A54A42B6C01A54FE099467CC3F4B8FD39001CA7EE217597134532E5850A35DFFB115F13CF2A41EC21541B40DA7A1ACF151F00EA1AF8F3DF57D36EA2333328D8128410337D0D772548CAA7485DF9D467BCE04576C401FECFF0301F481F621751B7D3777E8AFF1CEC1E356887FB17FBC9E91F1D1C1AFD423A9EBB756255BE826755B30876DA2F7FC0ED3CB2C5449468D8D5031423326C6DD48C3CEDB6A8CD9A83520D3B96D69354C161F0297D52266A372659E061660A33E647307CE32125AAB57F61F54566F92F40F5BD91F520581845B369A9E5A1F79DFAB78EF106E1BDC0E9533E73E0A2E2580EBCD55EA3062B420D96C17E118F0793D73208F96B4DE5DD7558E0AB24F2A19EA37A50682A1E4BEC2982FEB9AEB65F45BCFE82C6DFFEC68EF59842AA06A3C58C798294AAE0103D0C2968874464AFE9EA4ED1378A1AEE20FAC89752F090369DCECCB8A26EEE619A3D4C403C8EB34971604F629AB

---------ML-KEM Decaps---------
Alice's shared secret:
0x4A7EE1F982644EEDE653964D0752B5C518D9AFD4A2300827E35D67D26E8490C0

################################
###### K-PKE FINAL RESULT ######
################################

Alice's message:
0x33D4E25EB29927B29B6D197BB8FDA675DA6AF6ADA65E330C74C54257C4066CFA
Bob's message:
0x33D4E25EB29927B29B6D197BB8FDA675DA6AF6ADA65E330C74C54257C4066CFA

Alice's message matches Bob's!


#################################
###### ML-KEM FINAL RESULT ######
#################################

Alice's shared secret:
0x4A7EE1F982644EEDE653964D0752B5C518D9AFD4A2300827E35D67D26E8490C0
Bob's shared secret:
0x4A7EE1F982644EEDE653964D0752B5C518D9AFD4A2300827E35D67D26E8490C0

Alice's shared secret matches Bob's!

*/